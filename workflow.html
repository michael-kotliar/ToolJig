<!-- Author: Stephen R. Piccolo -->
<!-- Contact: https://piccolo.byu.edu -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Tooljig: A simple approach to building Common Workflow Language tool descriptions and workflows</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
</head>
<body>

<!--Here we import any JavaScript libraries that we need.-->
<!--Dev version of Vue<script--><script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!--Production version of Vue<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>

<!--Here we define any custom CSS attributes that we want to be used.-->
<style>
    .panel-default {
        cursor: pointer;
        background-color: #f7f2ef;
        color:#000000;
        padding-top: 10px;
        padding-bottom: 10px;
        padding-left: 10px;
        padding-right: 10px;
        border-radius: 4px 4px 0px 0px;
        border: 1px solid #f7f2ef;
}
</style>

<div class="container" align="left">
    <div id="cwl_app">
        <h2>ToolJig: A simple approach to building Common Workflow Language tool descriptions and workflows</h2>

        <p><img src="https://github.com/srp33/ToolJig/raw/master/Logo.jpg" width="400" /><br /><small><a href="https://unsplash.com/@vekonyorsi" target="_blank" class="text-muted" style="font-size: 10px">Image credit</a></small>
        </p>

        <p>The <a href="https://www.commonwl.org/" target="_blank">Common Workflow Language</a> (CWL) is an open specification for describing command-line tools and workflows. CWL documents are used in many scientific disciplines to ensure that tools and workflows can be executed in a manner that is portable across workflow engines and computer systems. <em>ToolJig</em> facilitates creation of CWL tool descriptions, workflows, and input-object files for those tools. <strong>This portion of ToolJig focuses on building workflows.</strong> Use <a href="tool.html" target="_blank">this app</a> if you wish to create tool descriptions.</p>

        <p>Workflows created in ToolJig are fully compatible with v1.2 of the <a href="https://commonwl.org/v1.2" target="_blank">CWL specification</a>. You can see some example CWL workflows <a href="https://github.com/srp33/ToolJig" target="_blank">here</a>. Our goal is support <em>common</em> use cases for research analyses. However, some options within the CWL specification are <em>not</em> supported; users should consult the specification if they wish to use other available features.</p>

        <hr style="border: 1px solid black;border-radius: 1px;" />

        <h4 class="card-title">Upload existing file (optional):</h4>

        <p>If you previously created a CWL workflow using ToolJig, you can upload it and then edit the information below. <font color="darkorange">(Uploading an existing file may not work for CWL files that were not created using alternative means.)</font> If you do <em>not</em> need to edit an existing CWL file, skip this step.</p>

        <div class="form-group">
            <input id="upload_file" type="file" placeholder="Please specify a file to be uploaded." class="form-control" v-on:change="onUploadFile" />
        </div>

        <hr style="border: 1px solid black;border-radius: 1px;" />

        <p>This section enables you to create a CWL workflow. Please fill in the information as requested below. Required field = <font color="red">*</font>.</p>

        <div class="panel panel-default" ref="inputPanel">
            <h4 class="card-title">Specify basics<sup><font color="red">*</font></sup>:</h4>

            <div class="form-group">
                <label for="workflow_id">Workflow identifier:</label>
                <input v-model="workflow_id" id="workflow_id" type="text" placeholder="Please enter a unique identifier." class="form-control" aria-describedby="helpBlock" />
                <div id="helpBlock" class="form-text text-muted">
                    This identifier must contain only letters, numbers, and underscores. This identifier will be used within the name of the CWL document that is generated.
                </div>
            </div>

            <div class="form-group">
                <label for="workflow_label">Label:</label>
                <input v-model="workflow_label" id="workflow_label" type="text" placeholder="Please enter a short description of the workflow." class="form-control" aria-describedby="helpBlock" />
                <div id="helpBlock" class="form-text text-muted">
                    This description will inform workflow users about its purpose and function.
                </div>
            </div>

            <div class="form-group">
                <label for="doc">Description:</label>
                <textarea v-model="doc" id="doc" rows=5 cols=100 placeholder="You may enter a longer description of the workflow." class="form-control" aria-describedby="helpBlock"></textarea>
                <div id="helpBlock" class="form-text text-muted">
                    This optional description can provide more detailed documentation about the workflow.
                </div>
            </div>

            <div class="form-group">
                <label for="author_name">Author's name:</label>
                <input v-model="author_name" id="author_name" type="text" placeholder="Please enter the author's name." class="form-control" aria-describedby="helpBlock" />
                <div id="helpBlock" class="form-text text-muted">
                    This is optional. Specifying the author's name is helpful to others who may use the workflow.
                </div>
            </div>

            <div class="form-group">
                <label for="author_orcid">Author's ORCID identifier:</label>
                <input v-model="author_orcid" id="author_orcid" type="text" placeholder="Please enter the author's ORCID identifier." class="form-control" aria-describedby="helpBlock" />
                <div id="helpBlock" class="form-text text-muted">
                    This is optional. Specifying the author's <a href="https://orcid.org" target="_blank">ORCID identifier</a> enables others who may use the workflow to obtain more information about the author.
                </div>
            </div>

            <div class="form-group">
                <label for="license">License:</label>
                <select v-model="license" id="license" class="form-control" class="form-control" aria-describedby="helpBlock">
                    <option value="AFL-3.0">Academic Free License v3.0</option>
                    <option value="Apache-2.0">Apache License 2.0</option>
                    <option value="BSD-3-Clause">BSD 3-Clause "New" or "Revised" License</option>
                    <option value="CC0-1.0">Creative Commons Zero v1.0 Universal</option>
                    <option value="CDDL-1.1">Common Development and Distribution License 1.1</option>
                    <option value="LGPL-3.0-or-later">GNU Lesser General Public License v3.0 or later</option>
                    <option value="MIT">MIT License</option>
                </select>
                <div id="helpBlock" class="form-text text-muted">
                    Please select a software license that applies to this CWL document. This will indicate conditions under which others can use the document. Details about these licenses and a more complete list can be found <a href="https://spdx.org/licenses/" target="_blank">here</a>. 
                </div>
            </div>

            <p v-if="basics_errors.length"><font color="red">
                <b>Please correct the following error(s):</b>
                <ul>
                  <li v-for="error in basics_errors">{{ error }}</li>
                </ul>
            </font></p>
        </div>

        <div class="panel panel-default" ref="uploadToolPanel">
            <h4 class="card-title">Upload tool descriptions:</h4>

            <p>The first step to creating a workflow is to upload CWL tool descriptions that will be used as steps within the workflow.</p>

            <div class="form-group">
                <input id="upload_tool_file" type="file" placeholder="Please specify a file to be uploaded." class="form-control" v-on:change="onUploadToolFile($event)" multiple />
            </div>

            <p v-if="Object.keys(tools).length > 0">Here you can see which tool files have been uploaded. You can also remove (<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>) these files if you wish.</p>

            <ol class="list-group">
                <li v-for="tool_name in Object.keys(sortObject(tools))" class="list-group-item">{{ tool_name }}
                    <button v-on:click="deleteTool(tool_name)" class="btn btn-default">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                </li>
            </ol>
        </div>

        <div class="panel panel-default" ref="stepsPanel" v-if="Object.keys(tools).length > 0">
            <h4 class="card-title">Define workflow steps:</h4>

            <p>Here you can define each step of the workflow.</p>
            
            <form v-on:submit.prevent="addUpdateStep">

                <div class="form-group">
                    <label for="step_tool">Select a tool for this step:</label>
                    <select v-model="newStepToolName" id="newStepToolName" ref="newStepToolName" class="form-control" v-on:change="getNewStepToolData_onchange">
                        <option disabled value="">Please select one...</option>
                        <option v-for="tool_name in Object.keys(sortObject(tools))" v-bind:value="tool_name">
                            {{ tool_name }}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="step_tool">Please specify a name for this step:</label>
                    <input v-model="newStepName" id="newStepName" ref="newStepName" type="text" placeholder="Only letters, numbers, and underscores are allowed." class="form-control" />
                </div>

                <div class="form-group" v-if="newStepToolName.length > 0 && newStepName.length > 0">
                    <label for="step_inputs">Specify input source(s):</label>

                    <p>The inputs for <code>{{ newStepToolName }}</code> are shown below. For each input, there are two options: 1) create a new input for the entire workflow that will be mapped to this input, or 2) indicate that the output of a prior step will be mapped to this input. Please indicate either option below. <span v-if="this.steps == 0">Because this is the first step of the workflow, the inputs can only be specified as workflow inputs.</span></p>

                    <input_dropdown 
                        v-for="(input, index) in newStepToolInputs" 
                        :key="input.inputName"
                        v-bind="input"
                        v-model="newStepToolInputs[index].selectedInputSource">
                    </input_dropdown>
                </div>

                <div class="form-group" v-if="newStepToolName.length > 0 && newStepName.length > 0">
                    <label for="step_inputs">Specify output destination(s) for this input:</label>

                    <p>The outputs for <code>{{ newStepToolName }}</code> are shown below. For each output, please indicate whether you would like the output to be collected for the entire workflow. If not, the output can be used as input in another step of the workflow.</p>

                    <p v-for="output in newStepToolOutputs">
                        <input type="checkbox" :value="output" :id="output" v-model="newStepToolOutputsChecked"> {{ output }}
                    </p>
                </div>

                <div class="form-group">
                    <button class="btn btn-info">Add / Update</button>
                </div>
            </form>

            <p v-if="steps.length > 0">Here you can see which steps have been added. You can also edit (<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>) or remove (<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>) steps if you wish.</p>

            <ol class="list-group">
                <li v-for="stepName in Object.keys(steps)" class="list-group-item">{{ stepName }}
                    <button v-on:click="editStep(stepName)" class="btn btn-default">
                        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                    </button>
                    <button v-on:click="deleteStep(stepName)" class="btn btn-default">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                    </button>
                </li>
            </ol>

            <p v-if="other_errors.length > 0"><font color="red">
                <b>Please correct the following error(s):</b>
                <ul>
                    <li v-for="error in other_errors">{{ error }}</li>
                </ul>
            </font></p>

            <pre v-text="cwl" v-if="cwl"></pre>

            <p><div class="form-group">
                <!--<button class="btn btn-info" variant="outline-primary" v-on:click="downloadCwl" :disabled="this.basics_errors.length > 0 || this.other_errors.length > 0">Download CWL file</button>-->
                <button class="btn btn-info" variant="outline-primary" v-on:click="downloadCwl" v-if="cwl.length > 0">Download CWL file</button>
            </div></p>
        </div>
    </div>
</div>

<script>
    // See https://zaengle.com/blog/using-v-model-on-nested-vue-components
    Vue.component("input_dropdown", {
        props: {
            inputName: {
                type: String,
                required: true
            },
            inputSourceOptions: {
                type: Array,
                required: true
            },
            value: {
                type: String,
                required: true
            }
        },
        template: `
            <div class="form-group">{{ inputName }}:
                <select v-model="selectedInputSource" class="form-control">
                    <option v-for="inputSourceOption in inputSourceOptions"
                        :value="inputSourceOption.id"
                        v-html="inputSourceOption.text"
                    ></option>
                </select>
            </div>`,
        computed: {
            selectedInputSource: {
                get() {return this.value},
                set(selectedInputSource) { this.$emit('input', selectedInputSource)}
            }
        }
    });

    new Vue({
        el: "#cwl_app",

        data: {
            upload_file: "",
            basics_errors: [],
            other_errors: [],
            workflow_id: "math",
            //TODO: workflow_id: "",
            workflow_label: "Simple workflow example",
            //TODO: workflow_label: "",
            //TODO: doc: "",
            doc: "This workflow accepts four integers, adds the first two, adds the last two, and then creates a text file that stores the two sums.",
            //TODO: doc: "This is a really cool workflow. This description is kinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda longkinda long kinda long.",
            //TODO: author_name: "",
            author_name: "Stephen Piccolo",
            //TODO: author_orcid: "",
            author_orcid: "https://orcid.org/0000-0003-2001-5640",
            license: "Apache-2.0",
            //TODO:
            tools: {},
            //tools: { "cat_tool.cwl": { "cwlVersion": "v1.2", "class": "CommandLineTool", "label": "cat tool", "requirements": { "ShellCommandRequirement": {}, "DockerRequirement": { "dockerImageId": "cat_tool", "dockerFile": "FROM python3.8.2" }, "NetworkAccess": { "class": "NetworkAccess", "networkAccess": true }, "InitialWorkDirRequirement": { "listing": [ { "entryname": "cat.py", "entry": "import sys\n\nfile_path1 = sys.argv[1]\nfile_path2 = sys.argv[2]\nout_file_path = sys.argv[3]\n\nwith open(file_path1) as file1:\n contents1 = file1.read()\n\nwith open(file_path2) as file2:\n contents2 = file2.read()\n\nwith open(out_file_path, 'w') as out_file:\n out_file.write(contents1 + \"\\n\")\n out_file.write(contents2 + \"\\n\")" } ] } }, "inputs": { "file1": { "type": "File", "doc": "An file with text", "format": "edam:format_1964" }, "file2": { "type": "File", "doc": "A second file", "format": "edam:format_1964" }, "output_file_name": { "type": "string", "doc": "Name of the output file\n#Output_File=edam:format_1964" } }, "arguments": [ { "shellQuote": false, "valueFrom": "python cat.py $(inputs.file1.path) $(inputs.file2.path) $(inputs.output_file_name)" } ], "outputs": { "output_from_input_1": { "type": "File", "outputBinding": { "glob": "$(inputs.output_file_name)" }, "doc": "Output file matching the name specified in the \"output_file_name\" input.", "format": "edam:format_1964" }, "standard_output": { "type": "stdout", "format": "edam:format_1964" }, "standard_error": { "type": "stderr", "format": "edam:format_1964" } }, "stdout": "stdout.txt", "stderr": "stderr.txt", "s:author": [ { "class": "s:Person", "s:name": "Stephen Piccolo" } ], "s:dateCreated": "2020-07-14", "s:license": "https://spdx.org/licenses/Apache-2.0", "$namespaces": { "s": "https://schema.org/", "edam": "http://edamontology.org/" }, "$schemas": [ "https://schema.org/version/latest/schemaorg-current-http.rdf", "http://edamontology.org/EDAM_1.23.owl" ] }, "add_tool.cwl": { "cwlVersion": "v1.2", "class": "CommandLineTool", "label": "add tool", "requirements": { "ShellCommandRequirement": {}, "DockerRequirement": { "dockerImageId": "add_tool", "dockerFile": "FROM python3.8.2" }, "NetworkAccess": { "class": "NetworkAccess", "networkAccess": true }, "InitialWorkDirRequirement": { "listing": [ { "entryname": "add.py", "entry": "import sys\n\nnumber1 = int(sys.argv[1])\nnumber2 = int(sys.argv[2])\nout_file_path = sys.argv[3]\n\nwith open(out_file_path, 'w') as out_file:\n total = number1 + number2\n out_file.write(str(total))" } ] } }, "inputs": { "number1": { "type": "int", "doc": "An integer" }, "number2": { "type": "int", "doc": "A second number" }, "output_file_name": { "type": "string", "doc": "Name of the output file\n#Output_File=edam:format_1964" } }, "arguments": [ { "shellQuote": false, "valueFrom": "python add.py $(inputs.number1) $(inputs.number2) $(inputs.output_file_name)" } ], "outputs": { "output_from_input_1": { "type": "File", "outputBinding": { "glob": "$(inputs.output_file_name)" }, "doc": "Output file matching the name specified in the \"output_file_name\" input.", "format": "edam:format_1964" }, "standard_output": { "type": "stdout", "format": "edam:format_1964" }, "standard_error": { "type": "stderr", "format": "edam:format_1964" } }, "stdout": "stdout.txt", "stderr": "stderr.txt", "s:author": [ { "class": "s:Person", "s:name": "Stephen Piccolo" } ], "s:dateCreated": "2020-07-14", "s:license": "https://spdx.org/licenses/Apache-2.0", "$namespaces": { "s": "https://schema.org/", "edam": "http://edamontology.org/" }, "$schemas": [ "https://schema.org/version/latest/schemaorg-current-http.rdf", "http://edamontology.org/EDAM_1.23.owl" ] } },
            //TODO:
            steps: {},
            //steps: { "add1": { "toolName": "add_tool.cwl", "selectedInputSources": { "number1": "Workflow_Input", "number2": "Workflow_Input", "output_file_name": "Workflow_Input"}, "useAsWorkflowOutputs": {"output_from_input_1": false}}, "add2": {"toolName": "add_tool.cwl", "selectedInputSources": {"number1": "Workflow_Input", "number2": "Workflow_Input", "output_file_name": "Workflow_Input"}, "useAsWorkflowOutputs": {"output_from_input_1": false}}, "cat": {"toolName": "cat_tool.cwl", "selectedInputSources": {"file1": "add1/output_from_input_1", "file2": "add2/output_from_input_1", "output_file_name": "Workflow_Input"}, "useAsWorkflowOutputs": {"output_from_input_1": true}} },
            newStepName: "",
            newStepToolName: "",
            newStepToolInputs: [],
            newStepToolOutputs: [],
            newStepToolOutputsChecked: []
        },
        computed: {
            cwl: function() {
                this.basics_errors = [];
                this.other_errors = [];

                if (this.workflow_id.trim() == "")
                    this.basics_errors.push("Please specify a workflow identifier.");

                if (/[^A-Za-z0-9_]+/.test(this.workflow_id))
                    this.basics_errors.push("The workflow identifier must only container letters, numbers, and underscores.")

                if (this.workflow_label.trim() == "")
                    this.basics_errors.push("Please specify a label.");

                if (this.author_orcid.trim() != "" && !this.isValidORCID(this.author_orcid))
                    this.basics_errors.push("Please specify a valid ORCID identifier (e.g., https://orcid.org/0000-0001-2222-3456).");

                if (this.steps.length < 2)
                    this.other_errors.push("Please specify at least two steps for the workflow.");

                var workflow_inputs = this.parseWorkflowInputs();
                var workflow_outputs = this.parseWorkflowOutputs();

                if (workflow_inputs.length < 1 || workflow_outputs.length < 1)
                    this.other_errors.push("Please specify at least one input and at least one output for the overall workflow.")

                if (this.basics_errors.length > 0 || this.other_errors.length > 0)
                    return "";

                return `cwlVersion: v1.2
class: Workflow
id: ${this.workflow_id}
label: ${this.workflow_label}
${this.buildOptionalString("doc: |-\n", this.indent(2, this.doc))}
${this.buildOptionalString("inputs:\n", this.indent(2, workflow_inputs))}
${this.buildOptionalString("outputs:\n", this.indent(2, workflow_outputs))}
${this.buildOptionalString("steps:\n", this.parseSteps())}
${this.parseAuthorInfo()}
s:dateCreated: "${this.getTodayDate()}"
s:license: https://spdx.org/licenses/${this.license}
$namespaces:
  s: https://schema.org/
  edam: http://edamontology.org/
$schemas:
 - https://schema.org/version/latest/schemaorg-current-http.rdf
 - http://edamontology.org/EDAM_1.23.owl
            `.replace(/\n{1,} {0,}\n{1,}/g, "\n\n").replace(/\n\n/g, "\n").replace(/\n\n/g, "\n").trim();
            },
            cwl_file_name: function() { return `${this.workflow_id}.cwl`; },
            job_file_name: function() { return `${this.workflow_id}_objects.yml`; },
            example_command: function() {
                return `cwltool ${this.cwl_file_name} ${this.job_file_name}`;
            }
        },

        methods: {
            onUploadFile: function(e) {
                var files = e.target.files || e.dataTransfer.files;
                if (!e.target.files.length) {
                    console.log("No file was detected.");
                    return;
                }

                const reader = new FileReader();

                reader.onload = event => {
                    e.target.value = "";
	            }

	            reader.onerror = (e) => {
                    alert("An error occurred when trying to parse the input file. Please contact the developer for help in addressing this problem.")
	                console.error(e);
	            }

	            // reader.readAsText(e.target.files[0]);
            },
            getYamlValue: function(yaml_dict, key_array) {
                // This goes iteratively deeper into the dictionary to try to find the value.
                my_dict = yaml_dict;
                var i;
                for (i = 0; i < key_array.length; i++) {
                    key = key_array[i];
                    if (key in my_dict)
                        my_dict = my_dict[key];
                    else
                        return "";
                }
                
                return my_dict;
            },
            onUploadToolFile: function(e) {
                const files = e.target.files || e.dataTransfer.files;

                if (files.length == 0) {
                    console.log("No file was detected.");
                    return;
                }

                Object.keys(files).forEach(i => {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        var fileName = files[i].name;
                        var fileContents = jsyaml.safeLoad(reader.result);

                        if (fileContents["class"] != "CommandLineTool") {
                            alert(`${fileName} is missing required element "class: CommandLineTool".`);
                            return;
                        }

                        if (fileContents["cwlVersion"] != "v1.2") {
                            alert(`${fileName} is not using the same version of the CWL spec as this workflow. It must use "cwlVersion: v1.2".`);
                            return;
                        }

                        if (fileName in this.tools) {
                            alert("Multiple tools with the same name cannot be used.");
                            return;
                        }

                        this.tools[fileName] = fileContents;
                        this.tools = Object.assign({}, this.tools, this.tools);
                    }

                    reader.onerror = (e) => {
                        alert("An error occurred when trying to parse the tool file.")
                        console.error(e);
                    }

                    reader.readAsText(file);
                });
            },
            deleteTool: function (toolName) {
                for (let stepName in this.steps) {
                    if (this.steps[stepName].toolName == toolName) {
                        alert(`The ${stepName} step is using this tool, so this tool cannot be deleted at this time.`)
                        return;
                    }
                }

                delete this.tools[toolName];
                this.tools = Object.assign({}, this.tools, this.tools);
            },
            // This is invoked when they select a tool for a given step.
            getNewStepToolData_onchange: function () {
                this.getNewStepToolData(newStepToolName.value);
            },
            // This obtains information about the tool selected for this step.
            getNewStepToolData: function (stepToolName_value) {
                var toolInputs = this.tools[stepToolName_value]["inputs"];
                var toolOutputs = this.tools[stepToolName_value]["outputs"];

                this.newStepToolInputs = [];
                for (let inputName in toolInputs) {
                    var inputType = toolInputs[inputName]["type"];

                    var selectedInputSource = "Workflow_Input";
                    if (this.newStepName in this.steps)
                        selectedInputSource = this.steps[this.newStepName].selectedInputSources[inputName];

                    // These are outputs from other steps that could be connected to the inputs for this step.
                    // They appear in the dropdown menus.
                    // Iterate through existing steps and see which outputs are the same type as this input.
                    // Ignore the step that the user is editing.
                    var inputSourceOptions = [{id: "Workflow_Input", text: "Create a new workflow input that will be mapped to this input"}];
                    for (let stepName in this.steps) {
                        if (stepName == this.newStepName)
                            continue;

                        var otherStepToolName = this.steps[stepName].toolName;

                        for (let otherStepOutputName in toolOutputs) {
                            var otherStepOutputType = toolOutputs[otherStepOutputName]["type"];

                            if (otherStepOutputType == inputType) {
                                var id = `${stepName}/${otherStepOutputName}`;
                                var text = `Use the ${otherStepOutputName} output of the ${stepName} step`;

                                inputSourceOptions.push({id: id, text: text});
                            }
                        }
                    }

                    this.newStepToolInputs.push({
                        inputName: inputName,
                        selectedInputSource: selectedInputSource,
                        inputSourceOptions: inputSourceOptions
                    });
                }

                // Iterate through the outputs and find any that the user wants to use as workflow outputs.
                this.newStepToolOutputs = [];
                this.newStepToolOutputsChecked = [];
                for (let outputName in toolOutputs) {
                    var outputType = toolOutputs[outputName]["type"];

                    if (outputType != "stdout" && outputType != "stderr") {
                        this.newStepToolOutputs.push(outputName);

                        if (this.newStepName in this.steps && this.steps[this.newStepName].useAsWorkflowOutputs[outputName]) {
                            this.newStepToolOutputsChecked.push(outputName);
                        }
                    }
                }
            },
            addUpdateStep() {
                if (this.newStepName.trim().length == 0 || /[^A-Za-z0-9_]+/.test(this.newStepName)) {
                    alert("A step name must be specified. It may only include letters, numbers, and underscores.");
                    return;
                }

                let selectedInputSources = {};
                var i;
                for (i = 0; i < this.newStepToolInputs.length; i++) {
                    selectedInputSources[this.newStepToolInputs[i].inputName] = this.newStepToolInputs[i].selectedInputSource;
                }

                let useAsWorkflowOutputs = {};
                for (let outputName of this.newStepToolOutputs) {
                    useAsWorkflowOutputs[outputName] = this.newStepToolOutputsChecked.includes(outputName);
                }

                this.steps[this.newStepName] = {toolName: this.newStepToolName, selectedInputSources: selectedInputSources, useAsWorkflowOutputs: useAsWorkflowOutputs};
                this.steps = Object.assign({}, this.steps, this.steps);

                this.newStepName = "";
                this.newStepToolName = "";
            },
            editStep: function (stepName) {
                let step = this.steps[stepName];

                this.newStepName = stepName;
                this.newStepToolName = step.toolName;
                this.getNewStepToolData(step.toolName);
                //this.$refs.newStepName.focus();
                //this.$refs.stepsPanel.scrollIntoView();
            },
            deleteStep: function (stepName) {
                for (let otherStepName in this.steps) {
                    for (let inputName in this.steps[otherStepName].selectedInputSources) {
                        var inputSource = this.steps[otherStepName].selectedInputSources[inputName];
                        
                        if (inputSource.split("/")[0] == stepName) {
                            alert(`At least one output ot this step is used as input to the ${otherStepName} step, so it cannot be deleted at this time.`);
                            return;
                        }
                    }
                }

                delete this.steps[stepName];
                this.steps = Object.assign({}, this.steps, this.steps);

                this.newStepName = "";
                this.newStepToolName = "";
            },
            parseWorkflowInputs() {
                var result = "";

                for (let stepName in this.steps) {
                    var toolName = this.steps[stepName].toolName;

                    for (let inputName in this.steps[stepName].selectedInputSources) {
                        var inputSource = this.steps[stepName].selectedInputSources[inputName];

                        if (inputSource == "Workflow_Input") {
                            var inputType = this.tools[toolName]["inputs"][inputName]["type"];
                            result += `${stepName}__${inputName}: ${inputType}\n`;
                        }
                    }
                }

                return result;
            },
            parseWorkflowOutputs() {
                var result = "";

                for (let stepName in this.steps) {
                    var toolName = this.steps[stepName].toolName;

                    for (let outputName in this.steps[stepName].useAsWorkflowOutputs) {
                        if (this.steps[stepName].useAsWorkflowOutputs[outputName]) {
                            var outputType = this.tools[toolName]["outputs"][outputName]["type"];

                            result += `${stepName}__${outputName}:\n`;
                            result += `  type: ${outputType}\n`;
                            result += `  outputSource: ${stepName}/${outputName}\n`;
                        }
                    }
                }

                return result;
            },
            parseSteps() {
                var result = "";

                for (let stepName in this.steps) {
                    var toolName = this.steps[stepName].toolName;

                    result += `  ${stepName}:\n`;
                    result += `    run: ${toolName}\n`;

                    var inputResult = "";
                    for (let inputName in this.steps[stepName].selectedInputSources) {
                        var inputSource = this.steps[stepName].selectedInputSources[inputName];

                        if (inputSource == "Workflow_Input") {
                            inputResult += `      ${inputName}: ${stepName}__${inputName}\n`;
                        }
                        else {
                            inputResult += `      ${inputName}: ${inputSource}\n`;
                        }
                    }

                    if (inputResult.length > 0)
                        result += "    in:\n" + inputResult;

                    var outputResult = "";
                    for (let outputName in this.steps[stepName].useAsWorkflowOutputs) {
                        var outputType = this.tools[toolName]["outputs"][outputName]["type"];

                        if (outputType != "stdout" && outputType != "stderr") {
                            outputResult += `      [${outputName}]\n`;
                        }
                    }

                    if (outputResult.length > 0)
                        result += "    out:\n" + outputResult;
                }

                return result;
            },
            parseAuthorInfo() {
                author_info = "";
                if (this.author_name.trim() != "" || this.author_orcid.trim() != "") {
                    author_info += "\ns:author:\n";
                    author_info += "  - class: s:Person\n";

                    if (this.author_name.trim() != "")
                        author_info += `    s:name: ${this.author_name.trim()}\n`;
                    if (this.author_orcid.trim() != "")
                        author_info += `    s:identifier: ${this.author_orcid.trim()}\n`;
                    author_info += "\n";
                }

                return author_info;
            },
            buildOptionalString: function(prefix, value) {
                if (value == "")
                    return "";
                else
                    return prefix + value;
            },
            indent: function(numSpaces, value) {
                if (value == "")
                    return "";

                prefix = "";
                var i;
                for (i = 0; i < numSpaces; i++)
                    prefix += " ";

                lines = value.split("\n");
                result = "";

                for (i = 0; i < lines.length; i++)
                {
                    result += prefix + lines[i];
                    if (i != (lines.length - 1))
                        result += "\n";
                }

                return result;
            },
            downloadCwl: function() {
                this.downloadFile(this.cwl_file_name, this.cwl);
            },
            downloadJob: function() {
                this.downloadFile(this.job_file_name, this.job);
            },
            downloadFile: function(fileName, contents) {
                //https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-server
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(contents));
                element.setAttribute('download', fileName);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            },
            getTodayDate: function() {
                var d = new Date();
                return [
                d.getFullYear(),
                ('0' + (d.getMonth() + 1)).slice(-2),
                ('0' + d.getDate()).slice(-2)
                ].join('-');
            },
            isValidORCID: function(orcid) {
                return (/https:\/\/orcid.org\/\d{4}-\d{4}-\d{4}-\d{4}/.test(orcid));
            },
            // Derived from https://www.w3docs.com/snippets/javascript/how-to-sort-javascript-object-by-key.html
            sortObject: function(obj) {
                return Object.keys(obj).sort().reduce(function (result, key) {
                    result[key] = obj[key];
                    return result;
                }, {});
            }
        }
    });
</script>

</body>
</html>